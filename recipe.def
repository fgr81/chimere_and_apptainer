BootStrap: library
From: debian:9

%setup
        _pwd=$(pwd)
        mkdir -p ${_pwd}/tmp
        export SINGULARITY_TMPDIR=${_pwd}/tmp

%files
        openmpi-2.0.4.tar.gz         /opt
	libpng-1.2.50.tar.gz	     /opt
        hdf5-1.8.20.tar.gz           /opt
        netcdf-c-4.6.0.tar.gz        /opt
        netcdf-fortran-4.4.4.tar.gz  /opt
        jasper-1.900.1.tar.gz        /opt
        blitz-0.10.tar.gz     	     /opt
        eccodes-2.8.0-Source.tar.gz  /opt
        

%environment
%runscript
%startscript
%test
%labels
  author: f.grasso@isac.cnr.it
%help
 
%post
        echo "***** Hello from inside the container *****"

	#echo "deb http://archive.debian.org/debian wheezy main" > /etc/apt/sources.list
	#echo "deb http://archive.debian.org/debian-archive/debian-security/ wheezy updates/main" >> /etc/apt/sources.list
	#echo "deb http://archive.debian.org/debian wheezy-backports main" >> /etc/apt/sources.list
	
        apt-get update
        apt-get install -y --force-yes texinfo vim dialog locales libtool autoconf git flex gawk
        apt-get install -y --force-yes build-essential gfortran g++ zlib1g-dev csh libcurl4-gnutls-dev libssl-dev
        apt-get install -y --force-yes wget subversion nco cdo locate python dos2unix zip unzip procps

        cd /opt
        tar xzvf openmpi-2.0.4.tar.gz
        cd /opt/openmpi-2.0.4
        CFLAGS=-m64 CXXFLAGS=-m64 FCFLAGS=-m64 ./configure --prefix=/usr/local --enable-static
        make all install
	ldconfig
        
        cd /opt
        tar xzvf libpng-1.2.50.tar.gz
        cd /opt/libpng-1.2.50
        CC=/usr/local/bin/mpicc ./configure --prefix=/usr/local
        make
        make install
	ldconfig
        
        cd /opt
        tar xzvf jasper-1.900.1.tar.gz
        cd /opt/jasper-1.900.1
        CC=/usr/local/bin/mpicc ./configure --prefix=/usr/local
        make
        make install
	ldconfig
        
        cd /opt
        tar xzvf hdf5-1.8.20.tar.gz
        cd /opt/hdf5-1.8.20
        CC=/usr/local/bin/mpicc FC=/usr/local/bin/mpif90 F90=/usr/local/bin/mpif90 FFLAGS=-I/usr/local/include CFLAGS=-I/usr/local/include CPPFLAGS=-I/usr/local/include ./configure --enable-parallel --prefix=/usr/local --enable-fortran
        make
        make install
	ldconfig
        
        cd /opt
        tar xvf netcdf-c-4.6.0.tar.gz
        cd netcdf-c-4.6.0
        CC=/usr/local/bin/mpicc LDFLAGS=-L/usr/local/lib CPPFLAGS=-I/usr/local/include ./configure --prefix=/usr/local --disable-dap-remote-tests --enable-parallel-tests
        make check install
	ldconfig
 
        cd /opt
        tar xzvf netcdf-fortran-4.4.4.tar.gz
        cd /opt/netcdf-fortran-4.4.4
        CPPFLAGS="-I/usr/local/include -DgFortran" LDFLAGS=-L/usr/local/lib FC=mpif90 F77=mpif90 CC=mpicc F77FLAGS="-O3 -fno-second-underscore" FCFLAGS="-O3 -fno-second-underscore" FFLAGS="-O3 -fno-second-underscore" ./configure --prefix=/usr/local --enable-shared
        make check install
	ldconfig

	apt-get install -y --force-yes cmake
	# apt-get install -y --force-yes cmake/wheezy-backports

        cd /opt
	tar xzvf blitz-0.10.tar.gz
	cd blitz-0.10
	./configure --prefix=/usr/local
        make lib
        make install
	ldconfig

	apt-get install -y python-dev

        cd /opt
        tar xzvf eccodes-2.8.0-Source.tar.gz
	cd eccodes-2.8.0-Source
        mkdir build
        cd build
        cmake ../
        make
        ctest
        make install
	ldconfig
